<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–∏–¥–µ–æ—à–∞–±–ª–æ–Ω—ã</title>

  <!-- Telegram MiniApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; padding: 16px; }
    h2 { margin: 0 0 12px; }
    .card { border: 1px solid #e6e6e6; border-radius: 14px; padding: 14px; }
    label { display: block; margin: 10px 0 6px; font-weight: 600; }
    select, input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    button { width: 100%; margin-top: 12px; padding: 12px 14px; border: 0; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .muted { color: #777; font-size: 13px; margin-top: 6px; }
    .ok { color: #0a7; margin-top: 12px; }
    .err { color: #c22; margin-top: 12px; }
  </style>
</head>
<body>
  <h2>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –≤–∏–¥–µ–æ—à–∞–±–ª–æ–Ω—ã</h2>

  <div class="card">
    <label>–®–∞–±–ª–æ–Ω</label>
    <select id="effect">
      <option value="ny_snow">‚ùÑÔ∏è –°–Ω–µ–≥ –∏ –º–∞–≥–∏—è</option>
      <option value="ny_glow">‚ú® –ù–µ–æ–Ω–æ–≤—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫</option>
      <option value="ny_fireworks">üéÜ –§–µ–π–µ—Ä–≤–µ—Ä–∫</option>
    </select>
    <div class="muted">–í—ã–±–µ—Ä–∏ —ç—Ñ—Ñ–µ–∫—Ç –∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ ‚Äî –≤–∏–¥–µ–æ –ø—Ä–∏–¥—ë—Ç –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.</div>

    <label>–ü–æ–∂–µ–ª–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
    <input id="prompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–¥–µ–ª–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ –∏ –≤–æ–ª—à–µ–±–Ω–æ" />

    <label>–§–æ—Ç–æ</label>
    <input id="photo" type="file" accept="image/*" />

    <button id="send">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É</button>

    <div id="status"></div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const btn = document.getElementById("send");
    const statusEl = document.getElementById("status");

    function setStatus(text, cls) {
      statusEl.className = cls || "";
      statusEl.textContent = text;
    }

    btn.addEventListener("click", async () => {
      const effect = document.getElementById("effect").value;
      const prompt = document.getElementById("prompt").value || "";
      const file = document.getElementById("photo").files[0];

      if (!file) {
        setStatus("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ üôÇ", "err");
        return;
      }

      btn.disabled = true;
      setStatus("‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ backend‚Ä¶", "");

      const fd = new FormData();
      fd.append("initData", tg.initData);     // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
      fd.append("effect_id", effect);
      fd.append("prompt", prompt);
      fd.append("photo", file);

      try {
        const res = await fetch("/api/kling_effect", { method: "POST", body: fd });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          setStatus("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ üòî " + (data.error ? ("(" + data.error + ")") : ""), "err");
          btn.disabled = false;
          return;
        }

        // ‚úÖ —É—Å–ø–µ—Ö: –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        setStatus("‚úÖ –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°–µ–π—á–∞—Å –∑–∞–∫—Ä–æ—é –æ–∫–Ω–æ‚Ä¶", "ok");

        // –ú–æ–∂–Ω–æ –µ—â—ë –ø–æ–∫–∞–∑–∞—Ç—å Telegram –Ω–∞—Ç–∏–≤–Ω—ã–π alert (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
        // tg.showAlert("–≠—Ñ—Ñ–µ–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–¥—ë—Ç –≤ —á–∞—Ç ‚ú®");

        setTimeout(() => {
          tg.close();
        }, 450);

      } catch (e) {
        setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ üòî " + e, "err");
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>